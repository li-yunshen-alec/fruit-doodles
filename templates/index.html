<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doodle Classifier</title>
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="../static/index.js"></script>
  <link rel="stylesheet"  type="text/css" href="{{url_for('.static', filename='style.css')}}">
</head>
<script>

  var preds = [ 0, 0, 0, 0 ];

  function plot() {

    console.log(preds)
    
    var canvas = document.getElementById("canvas");

    document.getElementById("chartContainer").style.display = "block";
    var ctx = canvas.getContext("2d");

    var image = new Image();
    image.onload = function() {
      ctx.drawImage(image, 0, 0);
    };
    
    var chart = new CanvasJS.Chart("chartContainer", {
      theme: "light2",
      animationEnabled: false,
      backgroundColor: "transparent",
      title: {
        text: "Detected Fruits"
      },
      axisY : {
        minimum: 0,
        maximum: 100
      },
      data: [{
        type: "pie",

        dataPoints: [{
            y: preds.preds[3] * 100,
            label: "Pineapple",
            color: "#5d4037"
          },
          {
            y: preds.preds[2] * 100,
            label: "Grape",
            color: "#48bf3c"
          },
          {
            y: preds.preds[1] * 100,
            label: "Banana",
            color: "#fccb00"
          },
          {
            y: preds.preds[0] * 100,
            label: "Apple",
            color: "Crimson"
          },
        ]
      }]
    });
    chart.render();

    var chart_data = chart.canvas.toDataURL("image/png");

    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/save-chart");
    xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhttp.send("chart_data=" + encodeURIComponent(chart_data));
    console.log('chart sent');  
  }
  
  setInterval(function()
  {
    var canvas = document.getElementById("canvas");
    var img = canvas.toDataURL();
    document.getElementById("payload").value = img;

    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/");
    xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhttp.send("payload=" + encodeURIComponent(img) + "&chart_data=chart_data");
    console.log('request');

    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        try {
          preds = JSON.parse(this.responseText); // Update preds with the server response
          plot();
        } catch (e) {
          console.error("Error parsing server response:", e);
          console.log("Server response:", this.responseText);
        }
      }
    };
  }, 500 );

</script>

<script>
  $.ajax({
      type: "POST",
      url: "/",  // the URL of your server
      success: function(response) {
          // Parse the JSON response
          var data = JSON.parse(response);

          var preds = data.preds;
          var classes = data.classes;
          var chart = data.chart;
      }
  });
  </script>

<body>
  <nav class="navbar navbar-dark bg-dark">
      <div class="navbar-nav left">
        <a class="nav-item nav-link" id="home" href="/">Doodle</a>
        <a class="nav-item nav-link" id="images" href="/display-images">My Images</a>
      </div>
      <div class="navbar-nav right">
          <button class="btn btn-success" id="saveButton">Save Image</button>
      </div>
  </nav>

  <div class="container">
    <div class="center-content">
      <form method='POST' onsubmit="return prepare()">
        <input type="hidden" id="payload" name="payload" value="x">
        <canvas id="canvas"></canvas>
        <div id="chartContainer" style="margin-left: 10%; display:none"></div>

        <script>
          plot();
        </script>
      </form>
    </div>
  </div>

  <div class="bottom-navbar">
    <button class="btn" id="brushButton">Brush Icon</button>
    <button class="btn" id="eraseButton">Erase Icon</button>
    <div class="slider-column">
      <div class="slider-row">
        <h1>S</h1>
        <input type="range" min="1" max="100" value="50" class="slider">
        <h1>L</h1>
      </div>
      <div class="color-picker">
        <button style="background-color: red;"></button>
        <button style="background-color: gold;"></button>
        <button style="background-color: green;"></button>
        <button style="background-color: brown;"></button>
      </div>
    </div>
    <button class="btn" id="clearButton">Clear Icon</button>
  </div>

  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

  <script type="text/javascript">
    function prepare() {
      var canvasObj = document.getElementById("canvas");
      var img = canvasObj.toDataURL();
      document.getElementById("payload").value = img;
      return true;
    }

    document.getElementById('saveButton').addEventListener('click', function() {
      var canvasObj = document.getElementById("canvas");
      var img = canvasObj.toDataURL();
      console.log('fjdkslafjdljklfsdajf;dkls');
      $.ajax({
        type: "POST",
        url: "/save-image",
        data: {
          imgBase64: img
        }
      }).done(function(o) {
        console.log('saved'); 
      });
    });    
  </script>
  <script src="../static/index.js"></script>
  </body>
</html>
